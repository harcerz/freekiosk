<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
<title>PDF Viewer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  html, body {
    width: 100%;
    height: 100%;
    background: #404040;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    -webkit-tap-highlight-color: transparent;
  }

  /* Toolbar */
  #toolbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 48px;
    background: #2b2b2b;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    z-index: 100;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    padding: 0 8px;
  }

  #toolbar button {
    background: #505050;
    color: #fff;
    border: none;
    border-radius: 6px;
    width: 40px;
    height: 36px;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  #toolbar button:active {
    background: #0066cc;
  }

  #toolbar button:disabled {
    opacity: 0.3;
    cursor: default;
  }

  #pageInfo {
    color: #ccc;
    font-size: 14px;
    min-width: 80px;
    text-align: center;
    user-select: none;
  }

  #toolbar .spacer {
    flex: 1;
  }

  /* Close button */
  #closeBtn {
    background: #cc3333 !important;
    font-size: 20px;
    font-weight: bold;
  }

  #closeBtn:active {
    background: #ff4444 !important;
  }

  /* PDF Container */
  #viewerContainer {
    position: absolute;
    top: 48px;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  #viewer {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 0;
    min-height: 100%;
  }

  .page-canvas {
    display: block;
    margin: 4px auto;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    max-width: 100%;
  }

  /* Loading / Error states */
  #loadingOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #404040;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 200;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255,255,255,0.2);
    border-top-color: #0066cc;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  #loadingText {
    color: #ccc;
    margin-top: 16px;
    font-size: 15px;
  }

  #errorOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #404040;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 200;
    padding: 24px;
  }

  #errorIcon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  #errorTitle {
    color: #fff;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
  }

  #errorMessage {
    color: #aaa;
    font-size: 14px;
    text-align: center;
    max-width: 300px;
    line-height: 1.5;
    margin-bottom: 20px;
  }

  #retryBtn {
    background: #0066cc;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 12px 32px;
    font-size: 16px;
    cursor: pointer;
  }

  #retryBtn:active {
    background: #0055aa;
  }

  #goBackBtn {
    background: transparent;
    color: #aaa;
    border: 1px solid #666;
    border-radius: 8px;
    padding: 10px 28px;
    font-size: 14px;
    cursor: pointer;
    margin-top: 12px;
  }
</style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div id="loadingText">Loading PDF...</div>
</div>

<!-- Error Overlay -->
<div id="errorOverlay">
  <div id="errorIcon">‚ö†Ô∏è</div>
  <div id="errorTitle">Cannot Load PDF</div>
  <div id="errorMessage">The PDF file could not be loaded.</div>
  <button id="retryBtn" onclick="retryLoad()">üîÑ Retry</button>
  <button id="goBackBtn" onclick="goBack()">‚Üê Go Back</button>
</div>

<!-- Toolbar -->
<div id="toolbar">
  <button id="closeBtn" onclick="goBack()" title="Close">‚úï</button>
  <div class="spacer"></div>
  <button id="prevBtn" onclick="prevPage()" title="Previous Page">‚óÄ</button>
  <span id="pageInfo">-- / --</span>
  <button id="nextBtn" onclick="nextPage()" title="Next Page">‚ñ∂</button>
  <div class="spacer"></div>
  <button id="zoomOutBtn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
  <button id="zoomFitBtn" onclick="zoomFit()" title="Fit Width" style="font-size:13px;">‚ä°</button>
  <button id="zoomInBtn" onclick="zoomIn()" title="Zoom In">+</button>
  <div class="spacer"></div>
  <button id="downloadBtn" onclick="downloadPdf()" title="Download PDF"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v13M12 16l-5-5M12 16l5-5M4 21h16"/></svg></button>
</div>

<!-- PDF Pages -->
<div id="viewerContainer">
  <div id="viewer"></div>
</div>

<script src="file:///android_asset/pdfjs/pdf.min.js"></script>
<script>
(function() {
  'use strict';

  // Configure PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'file:///android_asset/pdfjs/pdf.worker.min.js';

  // State
  var pdfDoc = null;
  var currentPage = 1;
  var totalPages = 0;
  var currentScale = 0; // 0 = fit-width (auto)
  var fitWidthScale = 1;
  var MIN_SCALE = 0.5;
  var MAX_SCALE = 3.0;
  var SCALE_STEP = 0.25;
  var renderingPages = {};

  // Get PDF URL from query string
  var params = new URLSearchParams(window.location.search);
  var pdfUrl = params.get('file');

  if (!pdfUrl) {
    showError('No PDF URL provided.');
    return;
  }

  // Notify RN of user interaction (for screensaver reset)
  function notifyInteraction() {
    try {
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage('user-interaction');
      }
    } catch(e) {}
  }

  // Interaction listeners
  document.addEventListener('touchstart', notifyInteraction, { passive: true });
  document.addEventListener('click', notifyInteraction, true);
  document.addEventListener('scroll', notifyInteraction, { passive: true });

  function showError(msg) {
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('errorOverlay').style.display = 'flex';
    document.getElementById('errorMessage').textContent = msg || 'Unknown error';
  }

  window.goBack = function() {
    notifyInteraction();
    if (window.history.length > 1) {
      window.history.back();
    } else {
      // Notify RN to go back
      try {
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'PDF_VIEWER_CLOSE' }));
        }
      } catch(e) {}
    }
  };

  window.retryLoad = function() {
    document.getElementById('errorOverlay').style.display = 'none';
    document.getElementById('loadingOverlay').style.display = 'flex';
    loadPdf(pdfUrl);
  };

  // Download PDF ‚Äî navigate to the PDF URL with a marker so the native
  // DownloadListener knows this is a deliberate download (not a view request)
  window.downloadPdf = function() {
    notifyInteraction();
    if (!pdfUrl) return;
    var dlUrl = pdfUrl + (pdfUrl.indexOf('?') !== -1 ? '&' : '?') + '__fk_dl=1';
    window.location.href = dlUrl;
  };

  // Page navigation
  window.prevPage = function() {
    if (currentPage <= 1) return;
    currentPage--;
    scrollToPage(currentPage);
    updatePageInfo();
    notifyInteraction();
  };

  window.nextPage = function() {
    if (currentPage >= totalPages) return;
    currentPage++;
    scrollToPage(currentPage);
    updatePageInfo();
    notifyInteraction();
  };

  // Zoom controls
  window.zoomIn = function() {
    var scale = getEffectiveScale();
    setScale(Math.min(scale + SCALE_STEP, MAX_SCALE));
    notifyInteraction();
  };

  window.zoomOut = function() {
    var scale = getEffectiveScale();
    setScale(Math.max(scale - SCALE_STEP, MIN_SCALE));
    notifyInteraction();
  };

  window.zoomFit = function() {
    currentScale = 0; // fit-width
    renderAllPages();
    notifyInteraction();
  };

  function getEffectiveScale() {
    return currentScale === 0 ? fitWidthScale : currentScale;
  }

  function setScale(scale) {
    currentScale = scale;
    renderAllPages();
  }

  function updatePageInfo() {
    document.getElementById('pageInfo').textContent = currentPage + ' / ' + totalPages;
    document.getElementById('prevBtn').disabled = (currentPage <= 1);
    document.getElementById('nextBtn').disabled = (currentPage >= totalPages);
  }

  function scrollToPage(pageNum) {
    var canvas = document.getElementById('page-' + pageNum);
    if (canvas) {
      canvas.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // Track current page on scroll
  var scrollTimeout;
  document.getElementById('viewerContainer').addEventListener('scroll', function() {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(function() {
      var container = document.getElementById('viewerContainer');
      var containerRect = container.getBoundingClientRect();
      var midY = containerRect.top + containerRect.height * 0.3;
      
      for (var i = 1; i <= totalPages; i++) {
        var canvas = document.getElementById('page-' + i);
        if (canvas) {
          var rect = canvas.getBoundingClientRect();
          if (rect.top <= midY && rect.bottom > midY) {
            currentPage = i;
            updatePageInfo();
            break;
          }
        }
      }
    }, 100);
  }, { passive: true });

  function renderPage(pageNum) {
    if (renderingPages[pageNum]) return;
    renderingPages[pageNum] = true;

    pdfDoc.getPage(pageNum).then(function(page) {
      var containerWidth = document.getElementById('viewerContainer').clientWidth - 16;
      var viewport = page.getViewport({ scale: 1 });
      
      // Calculate fit-width scale
      fitWidthScale = containerWidth / viewport.width;
      
      var scale = currentScale === 0 ? fitWidthScale : currentScale;
      var scaledViewport = page.getViewport({ scale: scale });

      var canvas = document.getElementById('page-' + pageNum);
      if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.id = 'page-' + pageNum;
        canvas.className = 'page-canvas';
        document.getElementById('viewer').appendChild(canvas);
      }

      var context = canvas.getContext('2d');
      
      // Use device pixel ratio for crisp rendering
      var dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(scaledViewport.width * dpr);
      canvas.height = Math.floor(scaledViewport.height * dpr);
      canvas.style.width = Math.floor(scaledViewport.width) + 'px';
      canvas.style.height = Math.floor(scaledViewport.height) + 'px';
      context.scale(dpr, dpr);

      page.render({
        canvasContext: context,
        viewport: scaledViewport
      }).promise.then(function() {
        renderingPages[pageNum] = false;
      }).catch(function() {
        renderingPages[pageNum] = false;
      });
    }).catch(function(err) {
      renderingPages[pageNum] = false;
      console.error('Error rendering page ' + pageNum + ':', err);
    });
  }

  function renderAllPages() {
    if (!pdfDoc) return;
    
    // Clear existing canvases
    var viewer = document.getElementById('viewer');
    viewer.innerHTML = '';
    renderingPages = {};
    
    for (var i = 1; i <= totalPages; i++) {
      renderPage(i);
    }
  }

  function loadPdf(url) {
    var loadingTask = pdfjsLib.getDocument({
      url: url,
      // Disable range requests for better compatibility with kiosk setups
      disableRange: false,
      disableStream: false,
      // CORS: try with credentials for same-origin
      withCredentials: false
    });

    loadingTask.promise.then(function(pdf) {
      pdfDoc = pdf;
      totalPages = pdf.numPages;
      currentPage = 1;
      
      // Hide loading
      document.getElementById('loadingOverlay').style.display = 'none';
      
      updatePageInfo();
      renderAllPages();

    }).catch(function(error) {
      console.error('PDF load error:', error);
      var msg = 'Unable to load PDF.';
      if (error && error.message) {
        if (error.message.indexOf('Missing PDF') !== -1) {
          msg = 'Invalid PDF file or URL.';
        } else if (error.message.indexOf('network') !== -1 || error.message.indexOf('fetch') !== -1) {
          msg = 'Network error. Check your connection.';
        } else {
          msg = error.message;
        }
      }
      showError(msg);
    });
  }

  // Handle window resize (orientation change)
  var resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      if (currentScale === 0) {
        renderAllPages();
      }
    }, 200);
  });

  // Start loading
  loadPdf(pdfUrl);

})();
</script>
</body>
</html>
